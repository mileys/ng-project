<section class="content-header">
    <h1 lang="text:inform_officer">
        通知人员
        <small>Version 2.0</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#" lang="text:site_maintain">现场维护</a></li>
        <li class="active" lang="text:inform_officer">通知人员</li>
    </ol>
</section>

<section class="content">
    <div class="nav-tabs-custom">
        <!-- Tab panes -->
        <div class="tab-content" style="padding-bottom: 0px;">
            <!--表格数据区-->
            <div class=" tab-pane row active">
                <div class="col-md-12">
                    <div class="box box-solid" style="margin-bottom: 0px;box-shadow: 0px 0px;">
                        <!--加载数据等待-->
                        <div class="overlay" style="display: none;">
                            <i class="fa icon-refresh icon-spin"></i>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-sm-12" style="padding-bottom: 10px;"><!--查询条件-->
                                    <form class="form-inline">
                                        <div class="box-tools pull-right">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-default btn-sm" title='新增' data-permissionFilter="[208]"
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:add" onclick="showModel_addOfficer();">
                                                    <i class="glyphicon glyphicon-plus"></i>
                                                </button>
                                                <button type="button" class="btn btn-default btn-sm" title='删除' data-permissionFilter="[208]"
                                                        data-toggle='tooltip' data-placement="bottom" lang="title:delete" onclick="delete_officer();">
                                                    <i class="glyphicon glyphicon-minus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div>
                                <table class="table table-bordered table-hover table-striped">
                                    <thead>
                                    <tr>
                                        <th id="tableHead_selectAll" style="width:1%">
                                            <input type="checkbox" id="tableHead_checkbok" data-toggle='tooltip' data-placement="bottom" lang="title:check_all">
                                        </th>
                                        <th lang="text:name" style="width: 25%;">姓名</th>
                                        <th lang="text:email" style="width: 30%;">邮箱</th>
                                        <th lang="text:phone" style="width:30%;">电话</th>
                                        <th style="width:24%;text-align:center;" lang="text:operate">操作</th>
                                    </tr>
                                    </thead>
                                    <tbody id="panelContent">

                                    <!--动态载入数据-->

                                    </tbody>
                                </table>
                            </div>
                        </div><!--box-body-->
                        <div id="page-footer">


                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<!--新增用户模态框-->
<div class="modal fade" id="model_increseOfficer">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" >
                    <span aria-hidden="true">×</span></button>
                <h4 class="modal-title" lang="text:add_officer"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="form_increseOfficer">
                    <input id="add_reset" type="reset" style="display:none;"/>
                    <div class="form-group">
                        <label for="officer_name" class="col-sm-2 control-label" >
                            <span lang="text:name"></span ><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[required,maxSize[30]]" name="name" id="officer_name"
                                   placeholder="姓名" lang="placeholder:name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="officer_email" class="col-sm-2 control-label" >
                            <span lang="text:email"></span ><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-10">
                            <input type="email" class="form-control validate[required,custom[email]]" name="email" id="officer_email"
                                   placeholder="email" lang="placeholder:email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="officer_phone" class="col-sm-2 control-label" lang="text:phone">
                            电话
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[custom[phone1]]" name="phone" value="" id="officer_phone"
                                   placeholder="phone" lang="placeholder:phone">
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <button id="btn_resetForm" type="reset" style="outline: none;background: white;border: none;"
                                data-toggle="tooltip" title="重新填写" lang="title:reset1">
                            <span class='glyphicon glyphicon-refresh' aria-hidden='true'
                                  style='color:green;font-size:150%;cursor: pointer;'></span>
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close" id="close_add_btn">关闭</button>
                <button type="button" class="btn btn-primary" onclick="add_Officer()" lang="text:submit">提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--修改用户信息模态框-->
<div class="modal fade" id="model_editOfficer">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="">
                    <span aria-hidden="true">×</span></button>
                <h4 class="modal-title" lang="text:edit_officer"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="form_editeOfficer">
                    <input type="reset" id="edit_reset" style="display:none;" />
                    <input type="hidden" value="" name="_id" id="officerId">
                    <div class="form-group">
                        <label for="editName" class="col-sm-2 control-label" >
                            <span lang="text:name"></span ><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[required,maxSize[30]]" name="name" id="editName"
                                   placeholder="姓名" lang="placeholder:name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="officer_email" class="col-sm-2 control-label" >
                            <span lang="text:email"></span ><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-10">
                            <input type="email" class="form-control validate[required,custom[email]]" name="email" id="editEmail"
                                   placeholder="email" lang="placeholder:email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPhone" class="col-sm-2 control-label" lang="text:phone">
                            电话
                        </label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control validate[custom[phone]]" name="phone" id="editPhone"
                                   placeholder="phone" lang="placeholder:phone">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" >
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal" lang="text:close" id="close_edit_btn"></button>
                <button type="button" class="btn btn-primary" onclick="edit_officer()" lang="text:submit">提交</button>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
    //验证配置
    validator.render("#form_increseOfficer", {
        promptPosition: "inline",
        scroll: false
    });
    validator.render("#form_editeOfficer", {
        promptPosition: "inline",
        scroll: false
    });

    //当页全选
    $("#tableHead_selectAll").on('click', function(event) {
        var selected = $("#panelContent tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#panelContent tr td input");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#panelContent tr td input").prop("checked", true);
                $("#tableHead_checkbok").prop("checked", true);
            } else {
                $("#panelContent tr td input").prop("checked", false);
                $("#tableHead_checkbok").prop("checked", false);
            }
        }
    });

    //获取通知人员列表
    function get_officer_list(cursor,limit) {
        loading();
        getAllOfficers(true,{verbose:100,limit:limit,cursor:cursor},function(data){
            if(data.total>0) {
                fill_officer_list(data.result);
                renderPagination(data, get_officer_list);
            }else {
                clearPagination();
                $("#panelContent").empty();
                $("#panelContent").append('<tr><td colspan="5"  align="center" lang="text:no_data"></td></tr>');
                unloading();
                locale.render({element: "#init_body"});
            }
        },this);
    }

    //回填通知人员列表
   function fill_officer_list(data) {
        $("#panelContent").empty();
        var str = "";
        for (var i = 0; i < data.length; i++) {
            var phone = typeof(data[i].phone) == 'undefined' ? '' : data[i].phone;
            str  ="<tr><td style='width:1%;'><input type='checkbox'  value='"+data[i].id+"'/></td>" +
                "<td style='width:25%;'>" + data[i].name + "</td>" +
                "<td style='width:30%;'>" + data[i].email + "</td>" +
                "<td style='width:30%;'>" + phone + "</td>" +
                "<td style='text-align:center;width:24%;'>" +
                "<span data-toggle='tooltip' title='编辑' lang='title:edit' data-permissionFilter='[208]'" +
                "onclick='showModel_edit_officer(\"" + data[i].id + "\")' style='padding: 3px 6px;'><span class='glyphicon glyphicon-edit link-black' aria-hidden='true' style=' cursor: pointer;'></span>&nbsp;</span>" +
                "</td>" +
                "</tr>";
            $("#panelContent").append(str);
        }
        //给input添加onclick事件
        $("tbody > tr > td > input").on("click", function() {
            var selected_rolesId = $("#panelContent tr td input[type='checkbox']:checked");
            var allUsers_nowPage = $("#panelContent tr td input");
            if (selected_rolesId.length < allUsers_nowPage.length) {
                $("#tableHead_checkbok").prop("checked", false);
            }
            if (selected_rolesId.length == allUsers_nowPage.length) {
                $("#tableHead_checkbok").prop("checked", true);
            }
        });
        locale.render({element: "#init_body"});
        unloading();
    }

    //每页显示条目切换回调函数
    function changePageNumber(limit) {
        get_officer_list(0, limit);
    }

    //跳转到指定页  回调函数
    function jumpTopage(cursor) {
        get_officer_list(cursor, $("#pageNumberSelect").val());
    }

    //显示新增通知人员模态框
    function showModel_addOfficer() {
        $("#model_increseOfficer").modal('show');
        $("#add_reset").click();
    }

    //新增通知人员
    function add_Officer() {
        var name = $("#officer_name").val();
        var email = $("#officer_email").val();
        var phone = $("#officer_phone").val();
        var addDataObject = {
            name:name,
            email:email,
            phone:phone
        }
        addOfficer(true,addDataObject,function(data){
            if(typeof(data.result)!="undefined") {
                dialog.render({
                    lang:"submit_success",
                });
                $("#close_add_btn").click();
                get_officer_list(0,parseInt($("#pageNumberSelect").val()));
            }else {
                dialog.render({
                    lang:"submit_failed",
                });
            }
            locale.render({element: "#init_body"});
        },this);
    }

    //删除通知人员
    function delete_officer() {
        var selected_officers = $("#panelContent tr td input[type='checkbox']:checked");
        if (selected_officers.length > 0) {
            dialog.render({
                lang: "deleteGatewayInfo",
                buttons: [{lang: "yes", click: function() {
                    selected_officers.each(function() {
                        deleteOfficer(false,$(this).val(),function (data) {

                        },this);
                    });
                    get_officer_list(0,parseInt($("#pageNumberSelect").val()));
                    dialog.close();
                }}, {lang: "no", click: function() {
                    selected_officers.attr("checked",false);
                    $("#tableHead_checkbok").prop("checked", false);
                    dialog.close();
                }}],
                close: function() {
                    dialog.close();
                }
            });
        } else {
            errorTipDis("select_del");
        }
        locale.render({element: "#init_body"});
    }

    //显示编辑模态框
    function showModel_edit_officer(id) {
        $("#model_editOfficer").modal('show');
        $("#edit_reset").click();
        get_officer_info(id);
    }

    // 获取通知人员信息
    function get_officer_info(id) {
        getOfficerById(true,id,function(data){
            if(data.result) {
                fill_officer_info(data.result);
            }
        },this);
    }

    // 回填通知人员信息
    function fill_officer_info(data) {
        $("#officerId").val(data.id);
        $("#editName").val(data.name);
        $("#editEmail").val(data.email);
        $("#editPhone").val(typeof(data.phone) =='undefined' ? '' : data.phone );
    }

    // 编辑通知人员
    function edit_officer() {
        var id = $("#officerId").val();
        var name = $("#editName").val();
        var email = $("#editEmail").val();
        var phone = $("#editPhone").val();
        var addDataObject = {
            name:name,
            email:email,
            phone:phone
        }
        editOfficer(true,id,addDataObject,function(data){
            if(typeof(data.result)!="undefined") {
                dialog.render({
                    lang:"submit_success",
                });
                $("#close_edit_btn").click();
                get_officer_list(0,parseInt($("#pageNumberSelect").val()));
            }else {
                dialog.render({
                    lang:"submit_failed",
                });
            }
            locale.render({element: "#init_body"});
        },this);
    }

    //重填
    $("#btn_resetForm").click(function(){
        $("#add_reset").click();
    });

    function loading() {
        $(".overlay").show();
    }
    function unloading() {
        $(".overlay").hide();
    }
    //页面功能权限过滤
    $(document).ready(function() {
        permissionFilter_pageFunc();
        require(['officerService'], function(officerService) {
            // 页面加载时初始化
            $("#page-footer").load("../admin/pagination.html", function () {
                get_officer_list(0,parseInt($("#pageNumberSelect").val()));
            });
        });
        locale.render({element: "#init_body"});
    });

</script>