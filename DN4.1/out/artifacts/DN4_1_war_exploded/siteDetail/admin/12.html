<!-- Main content -->
<section class="content-header">
    <h1 lang="text:production_line_statistics">
        产线统计
        <small>Version 2.0</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="javascript:void(0)" onclick="click2url(1);"><i class="icon-home"></i> Home</a></li>
    </ol>
</section>
<section class="content" id="tcontent">
    <div class="row">
        <div class="from-group" role="toolbar">
            <div class="col-md-3">
                <label  class="col-md-5  control-label" style="margin-top:6px;" lang="text:start_date">开始日期</label>
                <div class="input-group date">
                    <div class="input-group-addon">
                        <i class="icon-calendar"></i>
                    </div>
                    <input type="text"  id="startDate" data-provide="date-picker" class="form-control"  readonly="readonly"
                           onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')||\'2120-10-01\'}'})">
                </div>

            </div>
            <div class="col-md-3">
                <!-- <label for="exampleInputPassword1">结束日期</label> -->
                <label for="end_date_12" class="col-md-5  control-label" style="margin-top:6px;" lang="text:end_date">截止日期</label>
                <div class="input-group date">
                    <div class="input-group-addon">
                        <i class="icon-calendar"></i>
                    </div>
                    <input type="text"  id="endDate" data-provide="date-picker" class="form-control"  readonly="readonly"
                    onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'startDate\')}',maxDate:'%y-%M-%d'})"/>
                </div>
            </div><!-- /.col-lg-6 -->
            <div class="col-md-2">
                <button type="button" class="btn btn-default pull-left"  style="margin: 0px 15px;"  onClick="checkDataBtn()" lang="text:confirm">确定</button>
                <button type="button" class="btn btn-default pull-left" style="display:none" lang="text:export">导出</button>
            </div>
        </div>
    </div>
    <div id="allChars" style="margin-top: 20px;">
        <div class="row">
            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:output_statistics"></h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus"></i></button>
                            <!--button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="icon-times"></i></button-->
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="output-char" class="col-md-12 col-xs-12" style="height:220px;width:98%;padding:1px"  align="left">

                        </div>
                    </div>
                </div><!-- /.box -->
            </div>

            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:energy_consumption_statistics">能耗统计</h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus"></i></button>
                            <!--button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="icon-times"></i></button-->
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="nhtj-chart3_1" class="col-md-12 col-xs-12" style="height:220px;width:98%;padding:1px"  align="left">

                        </div>
                    </div>
                </div><!-- /.box -->
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:efficiency_statistics">效率统计</h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus"></i></button>
                            <!--button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="icon-times"></i></button-->
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="xltj-chart3_1" class="col-md-12 col-xs-12" style="height:220px;width:98%;padding:1px"  align="left">

                        </div>
                    </div>
                </div><!-- /.box -->
            </div>


            <div class="col-md-6">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:operation_time">运行时间</h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus"></i></button>
                            <!--button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="icon-times"></i></button-->
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="yxsj-chart3_1" class="col-md-12 col-xs-12" style="height:220px;width:98%;padding:1px"  align="left">

                        </div>
                    </div>
                    <div class="box-footer text-center">
				                <div id="output-footer"></div>
				            </div>
                </div><!-- /.box -->
            </div>
        </div>
    </div>

</section>
<script type="text/javascript" >
      require(['hisDataService','dataService', 'echarts'], function(hisDataService) {
          loadData(start_time,end_time);
          locale.render({element: "#init_body"});
      });
      //日历插件显示日期初始化
      function end() {
          var date = new Date();
          var mon = date.getMonth() + 1;
          var day = date.getDate();
          var nowDay = date.getFullYear() + "-" + (mon<10?"0"+mon:mon) + "-" +(day<10?"0"+day:day);
          return nowDay
      }
      $("#endDate").val(end());
      function start() {
        var date = new Date();
        var date1 = new Date(date.getTime() - 7 * 24 * 3600 * 1000);
        var mon = date1.getMonth() + 1;
        var day = date1.getDate();
        var nowDay = date1.getFullYear() + "-" + (mon<10?"0"+mon:mon) + "-" +(day<10?"0"+day:day);
        return nowDay

      }
      $("#startDate").val(start());
      function loadData(start_time,end_time) {
          var _id = sessionStorage.getItem("_id");
          var limit = 0;
          var verbose = 100;
          var params = {
              limit: limit,
              site_id: _id,
              verbose: verbose
          };
          //获取现场下机器的机型id
          loadMachines(params, function(data) {
              if (data.total && data.total > 0) {
                for(var i=0;i<data.result.length;i++){
                    if(data.result[i].name == 'JWF1211'){
                      var m=data.result[i];
                      var modelId=m.modelId;
                      var deviceId=m._id;
                    }
                }
                      getVarsByModelId(modelId, params, false, function(varData) {
                          if (varData.result && varData.result.varInfo && varData.result.varInfo.length > 0) {
                                    var varIds = [];
                                    for(var j=0;j<varData.result.varInfo[0].vars.length;j++){
                                      if(varData.result.varInfo[0].vars[j].name == '产量'){
                                        var varId=varData.result.varInfo[0].vars[j]._id;
                                        varIds.push(varId);
                                        console.log(varId);
                                      }
                                    }
                                  var queryData = {
                                      deviceId: deviceId,
                                      varIds: varIds
                                  };
                                  var devices = [];
                                  devices.push(queryData);
                                  var params = JSON.stringify({
                                      devices: devices
                                  });
                                  var startTime = $("#startDate").val();
                                  var st=new Date(startTime).getTime() / 1000;
                                  var startT = schneider.util.dateFormat(new Date(st), "yyyy/MM/dd 00:00:00")
                                  var start_time = new Date(startT).getTime() / 1000;
                                  var endTime = $("#endDate").val();
                                  var et = new Date(endTime).getTime() / 1000;
                                  var endT = schneider.util.dateFormat(new Date(et), "yyyy/MM/dd 23:59:59")
                                  var end_time = new Date(endT).getTime() / 1000;
                                  var query = {
                                      limit: 0,
                                      start_time: 1473811200,
                                      end_time: end_time
                                  };
                                  $("#load_").show();
                                  console.log(" time 1...",new Date().getTime());
                                  //获取历史数据
                                  history_data(query, params, function(data) {

                                      if (data.result && data.result.length > 0 && data.result[0].vars && data.result[0].vars.length > 0) {
                                          var varVal = data.result[0].vars[0];
                                          var result = {
                                              data: varVal.values
                                          };
                                           console.log(" time 2...",new Date().getTime());
                                          drawChart(result);
                                          
                                      }

                                  }, this);
                          }
                      }, this);
              }else{
                $("#output-footer").html(locale.get("no_data"));
              }
          });
      }
      var output_statistics = locale.get("output_statistics");
      function drawChart(result) {
        var option = lineOption;
          option.legend.data = [output_statistics];
          option.series[0].name = output_statistics;
          option.series[0].data = (function() {
              var d = [];
              for (var i = 0; i < result.data.length; i++) {
                  var data = result.data[i];
                  d.push([
                      new Date(data[0] * 1000),
                      data[1]
                  ]);
              }
              return d;
          })();

          require(
                  [
                      'echarts',
                      'echarts/chart/line', // 按需加载所需图表，如需动态类型切换功能，别忘了同时加载相应图表
                  ],
                  function (ec) {
                      var output = ec.init(document.getElementById("output-char"));
                      output.setOption(option);
                       console.log(" time 3...",new Date().getTime());
                  }
          );
          $("#load_").hide();
          locale.render({element: "#init_body"});
      }

      // 确定按钮
      var startTime = $("#startDate").val();
      var st=new Date(startTime).getTime() / 1000;
      var startT = schneider.util.dateFormat(new Date(st), "yyyy/MM/dd 00:00:00")
      var start_time = new Date(startT).getTime() / 1000;
      var endTime = $("#endDate").val();
      var et = new Date(endTime).getTime() / 1000;
      var endT = schneider.util.dateFormat(new Date(et), "yyyy/MM/dd 23:59:59")
      var end_time = new Date(endT).getTime() / 1000;
      function checkDataBtn(start_time,end_time){
            loadData(start_time,end_time);
          }
    // var  energyOption = {
    //     tooltip: {
    //         trigger: 'axis'
    //     },
    //     legend: {
    //         data:['能耗统计']
    //     },
    //     toolbox: {
    //         show: true,
    //         feature: {
    //             magicType: {show: true, type: ['line', 'bar']},
    //             restore: {show: true},
    //             saveAsImage: {show: true}
    //         }
    //     },
    //     xAxis:  {
    //         type: 'category',
    //         boundaryGap: false,
    //         data: data.x
    //     },
    //     yAxis: {
    //         type: 'value',
    //         axisLabel: {
    //             formatter: '{value} kw/h'
    //         }
    //     },
    //     series: [
    //         {
    //             name:'能耗统计',
    //             type:'line',
    //             data:data.y,
    //             markPoint: {
    //                 data: [
    //                     {type: 'max', name: locale.get({lang:"maxValue"})},
    //                     {type: 'min', name: locale.get({lang:"minValue"})}
    //                 ]
    //             },
    //             markLine: {
    //                 data: [
    //                     {type: 'average', name: locale.get({lang:"average"})}
    //                 ]
    //             }
    //         }
    //     ]
    // };
    // var  efficiencyOption = {
    //     tooltip: {
    //         trigger: 'axis'
    //     },
    //     legend: {
    //         data:['效率统计']
    //     },
    //     toolbox: {
    //         show: true,
    //         feature: {
    //             magicType: {show: true, type: ['line', 'bar']},
    //             restore: {show: true},
    //             saveAsImage: {show: true}
    //         }
    //     },
    //     xAxis:  {
    //         type: 'category',
    //         boundaryGap: false,
    //         data: data.x
    //     },
    //     yAxis: {
    //         type: 'value',
    //         axisLabel: {
    //             formatter: '{value} %'
    //         }
    //     },
    //     series: [
    //         {
    //             name:'效率统计',
    //             type:'line',
    //             data:data.y,
    //             markPoint: {
    //                 data: [
    //                     {type: 'max', name: locale.get({lang:"maxValue"})},
    //                     {type: 'min', name: locale.get({lang:"minValue"})}
    //                 ]
    //             },
    //             markLine: {
    //                 data: [
    //                     {type: 'average', name: locale.get({lang:"average"})}
    //                 ]
    //             }
    //         }
    //     ]
    // };
    // var datap={
    //     pie:[
    //                 {value:400, name:'抓棉机'},
    //                 {value:300, name:'混棉机'},
    //                 {value:200, name:'清棉机'},
    //                 {value:400, name:'梳棉机'}]
    // }
    // var dOption = {
    //     tooltip : {
    //         trigger: 'item',
    //         formatter: "{a} <br/>{b} : {c} ({d}%)"
    //     },
    //     legend: {
    //         orient : 'vertical',
    //         x : 'left',
    //         data:['抓棉机','混棉机','清棉机','梳棉机']
    //     },
    //     toolbox: {
    //         show : true,
    //         feature : {
    //             //mark : {show: true},
    //             //dataView : {show: true, readOnly: false},
    //             restore : {show: true},
    //             saveAsImage : {show: true}
    //         }
    //     },
    //     calculable : false,
    //     series : [
    //         {
    //             name:'',
    //             type:'pie',
    //             radius : '55%',
    //             center: ['50%', '60%'],
    //             data:datap.pie
    //         }
    //     ]
    // };
    // require(
    //         [
    //             'echarts',
    //             'echarts/chart/line', // 按需加载所需图表，如需动态类型切换功能，别忘了同时加载相应图表
    //             'echarts/chart/bar',
    //             'echarts/chart/pie'
    //         ],
    //         function (ec) {
    //             var cltjChart2 = ec.init(document.getElementById("cltj-chart3_1"));
    //             cltjChart2.showLoading({
    //                 text: '正在努力的读取数据中...'
    //             });
    //             cltjChart2.setOption(outputOption);
    //             cltjChart2.hideLoading();
    //             var nhtjChart = ec.init(document.getElementById("nhtj-chart3_1"));
    //             nhtjChart.setOption(energyOption);
    //             var xltjChart = ec.init(document.getElementById("xltj-chart3_1"));
    //             xltjChart.setOption(efficiencyOption);
    //             var yxsjChart = ec.init(document.getElementById("yxsj-chart3_1"));
    //             yxsjChart.setOption(dOption);
    //         }
    // );

</script>
