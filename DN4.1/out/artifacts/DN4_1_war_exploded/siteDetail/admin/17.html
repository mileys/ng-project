<script type="text/javascript">
			require(['hisDataService','dataService', 'echarts'], function(hisDataService) {
					loadData(start_time,end_time);
					locale.render({element: "#init_body"});
			});

			function loadData(start_time,end_time) {
					var _id = sessionStorage.getItem("_id");
					var limit = 0;
					var verbose = 100;
					var params = {
							limit: limit,
							site_id: _id,
							verbose: verbose
					};
					//获取现场下机器的机型id
					loadMachines(params, function(data) {
							if (data.total && data.total > 0) {
								for(var i=0;i<data.result.length;i++){
										if(data.result[i].name == 'JWF1211'){
											var m=data.result[i];
											var modelId=m.modelId;
											var deviceId=m._id;
										}
								}
											getVarsByModelId(modelId, params, false, function(varData) {
													if (varData.result && varData.result.varInfo && varData.result.varInfo.length > 0) {
																		var varIds = [];
																		for(var j=0;j<varData.result.varInfo[0].vars.length;j++){
																			if(varData.result.varInfo[0].vars[j].name == '产量'){
																				var varId=varData.result.varInfo[0].vars[j]._id;
																				varIds.push(varId);
																				console.log(varId);
																			}
																		}
																	var queryData = {
																			deviceId: deviceId,
																			varIds: varIds
																	};
																	var devices = [];
																	devices.push(queryData);
																	var params = JSON.stringify({
																			devices: devices
																	});
																	var startTime = $("#startDate").val();
													        var st=new Date(startTime).getTime() / 1000;
													        var startT = schneider.util.dateFormat(new Date(st), "yyyy/MM/dd 00:00:00")
													        var start_time = new Date(startT).getTime() / 1000;
													        var endTime = $("#endDate").val();
													        var et = new Date(endTime).getTime() / 1000;
													        var endT = schneider.util.dateFormat(new Date(et), "yyyy/MM/dd 23:59:59")
													        var end_time = new Date(endT).getTime() / 1000;
																	var query = {
																			limit: 0,
																			start_time: 1473811200,
																			end_time: end_time
																	};
																	$("#load_").show();
																	//获取历史数据
																	history_data(query, params, function(data) {

																			if (data.result && data.result.length > 0 && data.result[0].vars && data.result[0].vars.length > 0) {
																					var varVal = data.result[0].vars[0];
																					var result = {
																							data: varVal.values
																					};
																					drawChart(result);
																			}

																	}, this);
													}
											}, this);
							}else{
								$("#output-footer").html(locale.get("no_data"));
							}
					});
			}
			var output_statistics = locale.get("output_statistics");
			function drawChart(result) {
				var option = lineOption;
					option.legend.data = [output_statistics];
					option.series[0].name = output_statistics;
					option.series[0].data = (function() {
							var d = [];
							for (var i = 0; i < result.data.length; i++) {
									var data = result.data[i];
									d.push([
											new Date(data[0] * 1000),
											data[1]
									]);
							}
							return d;
					})();

					require(
	                [
	                    'echarts',
	                    'echarts/chart/line', // 按需加载所需图表，如需动态类型切换功能，别忘了同时加载相应图表
	                ],
	                function (ec) {
	                    var output = ec.init(document.getElementById("output-char"));
	                    output.setOption(option);
	                }
	        );
					$("#load_").hide();
					locale.render({element: "#init_body"});
			}



				//日历插件显示日期初始化
				function end() {
						var date = new Date();
						var mon = date.getMonth() + 1;
						var day = date.getDate();
						var nowDay = date.getFullYear() + "-" + (mon<10?"0"+mon:mon) + "-" +(day<10?"0"+day:day);
						return nowDay
				}
				$("#endDate").val(end());
				function start() {
					var date = new Date();
					var date1 = new Date(date.getTime() - 7 * 24 * 3600 * 1000);
					var mon = date1.getMonth() + 1;
					var day = date1.getDate();
					var nowDay = date1.getFullYear() + "-" + (mon<10?"0"+mon:mon) + "-" +(day<10?"0"+day:day);
					return nowDay

				}
				$("#startDate").val(start());
				// 确定按钮
				var startTime = $("#startDate").val();
        var st=new Date(startTime).getTime() / 1000;
        var startT = schneider.util.dateFormat(new Date(st), "yyyy/MM/dd 00:00:00")
        var start_time = new Date(startT).getTime() / 1000;
        var endTime = $("#endDate").val();
        var et = new Date(endTime).getTime() / 1000;
        var endT = schneider.util.dateFormat(new Date(et), "yyyy/MM/dd 23:59:59")
        var end_time = new Date(endT).getTime() / 1000;
				function outputBtn(start_time,end_time){
							loadData(start_time,end_time);
						}
</script>
<!-- Main content -->
<section class="content-header">
    <h1 lang="text:output_statistics">
        产量统计
        <small>Version 2.0</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="javascript:void(0)" onclick="click2url(1)"><i class="icon-home"></i> Home</a></li>
    </ol>
</section>
<section class="content" id="tcontent">
    <div class="row">
        <div class="from-group" role="toolbar">
           <div class="col-xs-4">
                               <label for="startDate" class="col-sm-5 control-label" style="margin-top: 6px;/* margin-right: -50px; */width: 90px;margin-left: -12px;">开始日期</label>
                                <div class="input-group date" style="width: 180px">
                                    <div class="input-group-addon">
                                        <i class="icon-calendar"></i>
                                    </div>
                                    <input type="text"  id="startDate" data-provide="date-picker" class="form-control"  readonly="readonly"
                                    onfocus="WdatePicker({maxDate:'#F{$dp.$D(\'endDate\')||\'2120-10-01\'}'})">
                                </div>
            </div>
            <div class="col-xs-3">
                                 <label for="end_date_12" class="col-sm-5 control-label" style="margin-top: 6px;/* margin-right: -50px; */width: 90px;margin-left: -20px;">截止日期</label>
                                <div class="input-group date">
                                    <div class="input-group-addon">
                                        <i class="icon-calendar"></i>
                                    </div>
                                    <input type="text"  id="endDate" data-provide="date-picker" class="form-control"  readonly="readonly"  onfocus="WdatePicker({dateFmt:'yyyy-MM-dd',minDate:'#F{$dp.$D(\'startDate\')}',maxDate:'%y-%M-%d'})"/>
                            </div>
            </div>
            <div class="col-xs-1">
                <button type="button" id="sureBtn" class="btn btn-default pull-left"  onClick="outputBtn()">确定</button>
            </div>
            <div class="col-xs-1">
                <button type="button" class="btn btn-default pull-left"  style="display: none">导出</button>
            </div>
        </div>
        </div>

    <div id="allChars" >
        <div class="row">
            <div class="col-md-12">
               <div class="box" style="margin:15px 0px 0px 15px;">
								 <div class="overlay" style="display: none;" id="load_">
								     <i class="fa icon-refresh icon-spin"></i>
								 </div>
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:output_statistics">产量统计</h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" title="Collapse"><i class="icon-minus"></i></button>
                            <!--button class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove"><i class="icon-times"></i></button-->
                        </div>
                    </div>
                    <div class="box-body">
                        <div id="output-char" class="col-md-12 col-xs-12" style="height:350px;width:100%;padding:1px"  align="left">

                        </div>
                    </div><!-- /.box-body -->
										<div class="box-footer text-center">
				                <div id="output-footer"></div>
				            </div>
                </div><!-- /.box -->
            </div>
        </div>
    </div>
</section>
