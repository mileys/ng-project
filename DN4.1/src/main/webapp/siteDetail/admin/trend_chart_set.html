<style>
    .img-position {
        width: 16px;
        position: relative;
        margin-top: -24px;
        margin-left: -2px;
    }

</style>

<section class="content-header">
    <h1 lang="text:trend_chart_set">
        趋势图设置
    </h1>
    <ol class="breadcrumb">
        <li><a href="#" lang="text:data_allocation"></a></li>
        <li class="active"><a lang="text:trend_chart_set"></a></li>
    </ol>
</section>

<section class="content">
    <div class="nav-tabs-custom" >
        <!--表格统计-->
        <div class="tab-pane">
            <div>
                <div class="box">
                    <div class="overlay" style="display: none;" id="load1">
                        <i class="fa icon-refresh icon-spin"></i>
                    </div>
                    <div class="box-header with-border">
                        <h3 class="box-title" lang="text:trend_chart_set"></h3>
                        <div class="box-tools pull-right">
                            <button class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip" ><i class="icon-minus"></i></button>
                        </div>
                    </div>
                    <div class="box-body">
                        <div class="row">
                            <div class="col-sm-12" style="padding-bottom: 10px;">
                                <form class="form-inline">
                                    <div class="form-group">
                                        <input style="cursor:auto;" type="text" name="search" class="form-control input-sm" id="group_inp" placeholder lang="placeholder:enter_the_gruop_name">
                                        <button type="button" id="searchGroup" data-permissionFilter='[211]' class="btn btn-default btn-sm" data-toggle="tooltip" title="查询" lang="title:query" id="btn_research">
                                            <span class="glyphicon glyphicon-search"></span>
                                        </button>
                                    </div>
                                    <div class="form-group pull-right" >
                                        <div class="btn-group">
                                            <button id="addGroup" type="button" data-permissionFilter='[212]' class="btn btn-default btn-sm" title="添加" data-toggle="tooltip" data-placement="bottom" lang="title:add" data-permissionFilter="[]">
                                                <i class="glyphicon glyphicon-plus"></i>
                                            </button>
                                            <button id="deleteGroup" type="button" data-permissionFilter='[216]' class="btn btn-default btn-sm" title="删除" data-toggle="tooltip" data-placement="bottom" lang="title:delete" data-permissionFilter="[]">
                                                <i class="glyphicon glyphicon-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div>
                            <table class="table table-bordered table-striped" id="table1">
                                <thead>
                                <tr>
                                    <th id="allSelected1"  style="width:1%;">
                                        <input type="checkbox" id="table1_checkbok" data-toggle='tooltip' data-placement="bottom" lang="title:check_all">
                                    </th>
                                    <th style="width:20%;" lang="text:group"></th>
                                    <th style="width:20%;" lang="text:display_location"></th>
                                    <th style="width:50%;" lang="text:group_content_preview"></th>
                                    <th style="text-align: center; width: 9%;" lang="text:operate"></th>
                                </tr>
                                </thead>
                                <tbody id="table1_tbody">
                                <!--动态载入数据-->
                                    <tr>
                                        <td colspan="5" style="text-align: center;" lang="text:no_data"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="page-footer"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- 添加编辑变量模态框 -->
<div class="modal fade bs-example-modal-lg" id="addBox" data-target=".bs-example-modal-lg" >
    <div class="modal-dialog modal-lg" data-target=".bs-example-modal-lg">
        <div class="modal-content">
            <div class="modal-header" >
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 id="modal_title" class="modal-title"></h4>
            </div>
            <div class="modal-body" style="overflow-y: auto;height:451px;">
                <form class="form-horizontal" id="form_add_Group">
                    <input type="reset" id="form_reset" class="hidden"/>
                    <div class="form-group">
                        <label for="add_group_name" class="col-sm-2 control-label" style="text-align: left;">
                            <span lang="text:group_name"></span><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control input-sm validate[required]" name="name" id="add_group_name" lang="placeholder:group_name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="add_group_name" class="col-sm-2 control-label" style="text-align: left;">
                            <span lang="text:group_type">趋势类型</span><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-3" id="type_div">
                            <input id="shunshi" type="checkbox" value="instant" checked="checked"/><span lang="text:instantaneous" style="margin-right: 15px;"></span>
                            <input id="tongji" value="!instant" type="checkbox"/><span lang="text:statistics">统计</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="add_group_name" class="col-sm-2 control-label" style="text-align: left;">
                            <span lang="text:display_location">显示位置</span>
                        </label>
                        <div class="col-sm-3" id="display_div">
                            <input type="checkbox" value="1"><span lang="text:overall_monitoring" style="margin-right: 15px;"></span>
                            <input type="checkbox" value="2"><span lang="text:historical_trend">历史趋势</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="text-align: left;padding-right: 0px;">
                            <span lang="text:selected_variables">已选变量</span>
                        </label>
                        <label id="selectedVarContent" class="col-sm-10 control-label" style="text-align: left;font-weight: 500;">

                        </label>
                    </div>
                </form>
                <div class="row" style="margin-top:30px;">
                    <div class="col-sm-12" style="padding-bottom: 10px;">
                        <form class="form-inline">
                            <div class="form-group">
                                <input style="cursor:auto;" type="text" name="search" class="form-control input-sm" id="name_inp" placeholder lang="placeholder:enter_the_name">
                                <button type="button" id="searchVariable" onclick="getVarByName();" class="btn btn-default btn-sm" data-toggle="tooltip" title="查询" lang="title:query">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="dataList">
                    <div class="overlay" style="display: none;" id="load2">
                        <i class="fa icon-refresh icon-spin"></i>
                    </div>
                    <table class="table table-bordered table-striped scrolltable" id="table2">
                        <thead style="display:block;">
                            <tr>
                                <th  style="width:99px; border-bottom: none; text-align: center;" lang="text:choose"></th>
                                <th style="width:250px; border-bottom: none;"  lang="text:name1"></th>
                                <th style="width:200px; border-bottom: none;"  lang="text:register_address"></th>
                                <th style="width:200px; border-bottom: none;" lang="text:unit"></th>
                                <th style="width:119px;border-bottom: none;" lang="text:writable"></th>
                            </tr>
                        </thead>
                            <tbody id="table2_tbody" style="display:block; max-height:117px;overflow-y: auto;">
                            <!--动态载入数据-->
                                <tr>
                                    <td colspan="5" style="text-align: center;width:868px;height: 37px;background-color: #f9f9f9;" lang="text:no_data"></td>
                                </tr>
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="addDeviceContentBox">
                    <button type="button" class="btn btn-default pull-left"  data-dismiss="modal" lang="text:close">关闭</button>
                    <button type="button" class="btn btn-primary" id="submitVariable"  lang="text:submit">提交</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详情模态框 -->
<div class="modal fade bs-example-modal-lg" id="detailBox" data-target=".bs-example-modal-lg" >
    <div class="modal-dialog modal-lg" data-target=".bs-example-modal-lg">
        <div class="modal-content">
            <div class="modal-header" >
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
                <h4 id="" class="modal-title" lang="text:detail_group"></h4>
            </div>
            <div class="modal-body" style="overflow-y: auto;height:450px;">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="detail_group_name" class="col-sm-2 control-label" style="text-align: left;">
                            <span lang="text:group_name"></span><span class="text-red">*</span>
                        </label>
                        <div class="col-sm-3">
                            <input type="text" readonly="readonly " class="form-control input-sm validate[required]" name="name" id="detail_group_name" lang="placeholder:group_name">
                        </div>
                    </div>
                </form>
                <div id="detailList" >
                    <table class="table table-bordered table-striped">
                        <thead style="display:block;">
                        <tr>
                            <th style="width:349px;border-bottom: none;"  lang="text:name1"></th>
                            <th id="th_two" style="width:250px;border-bottom: none;"  lang="text:register_address"></th>
                            <th id="th_three" style="width:150px;border-bottom: none;" lang="text:unit"></th>
                            <th style="width:119px;border-bottom: none;" lang="text:writable"></th>
                        </tr>
                        </thead>
                        <tbody id="detail_tbody" style="display:block; max-height:296px;overflow-y: auto;">
                        <!--动态载入数据-->
                        <tr>
                            <td colspan="4" style="text-align: center;width: 868px;" lang="text:no_data"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="addDeviceContentBox">
                    <button type="button" class="btn btn-default pull-left"  data-dismiss="modal" lang="text:close">关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" >
    loading();
    var vArr = []; // 已选变量
    var globalVars = []; // 存放现场下所有的变量
    var site_Id = getQueryParam("id");
    var groupId = "";
    var device_Id = "";
    $(document).ready(function(){
        permissionFilter_pageFunc();
        require(['varService','siteService'],function(){
             init();
         });
        locale.render({element: "#init_body"});
    });
    //验证配置
    validator.render("#form_add_Group", {
        promptPosition: "inline",
        scroll: false
    });

    function init() {
        getTrendList();
    }

    //获取所有的变量根据类型
    function getAllVars(calc_mode) {
        getSiteVarsList(site_Id,{"calc_mode":calc_mode},false,function(data){
            if(typeof(data.result)!=="undefined") {
                fillTableData2(data.result);
            }else{
                $("#table2_tbody").empty().append('<td colspan="5" style="text-align: center;width:848px;background-color: #f9f9f9;" lang="text:no_data"></td>');
                unload2();
            }
        },this);
    }

    //瞬时和统计切换
    $("#tongji").click(function(){
        loading2();
        vArr = [];
        $("#selectedVarContent").empty();
        if($("#tongji").prop("checked")=="checked") {
            $("#tongji").prop("checked","checked");
            $("#shunshi").prop("checked","");
        }else {
            $("#tongji").prop("checked","checked");
            $("#shunshi").prop("checked","");
        }
        getAllVars(1);
    });
    $("#shunshi").click(function(){
        loading2();
        vArr = [];
        $("#selectedVarContent").empty();
        if($("#shunshi").prop("checked")=="checked") {
            $("#shunshi").prop("checked","checked");
            $("#tongji").prop("checked","");
        }else {
            $("#shunshi").prop("checked","checked");
            $("#tongji").prop("checked","");
        }
        getAllVars(0);
    });

    //获取趋势组列表
    function getTrendList(){
        getTrends(site_Id,{},false,function(data){
            if(data.result) {
                fillTableData(data.result);
            }else {
                unload();
                $("#table1_tbody").empty().append('<tr> <td colspan="5" style="text-align: center;" lang="text:no_data"></td></tr>');
            }
        },this);
        locale.render({element: "#init_body"});
    }

    //根据名称搜索全局变量
    function getVarByName() {
        loading2();
        var name = $.trim($("#name_inp").val());
        var calc_mode = $("#type_div :checkbox:checked").val();
        if(calc_mode=="instant") {
            calc_mode=0;
        }else{
            calc_mode=1;
        }
        getSiteVarsList(site_Id,{"calc_mode":calc_mode,"name":name},false,function(data){
            if(typeof(data.result)!=="undefined") {
                fillTableData3(data.result);
            }else {
                $("#table2_tbody").empty().append('<td colspan="5" style="text-align: center;width:848px;" lang="text:no_data"></td>');
                unload2();
            }
        },this);
    }

    //搜索后填充变量列表
    function fillTableData3(data) {
        var str = "";
        for(var i =0; i < data.length; i++) {
            var writeable;
            if(typeof(data[i].writeable)!="undefined") {
                writeable = locale.get("yesText");
            }else {
                writeable = locale.get("noText");
            }
            str += '<tr>'+
                '<td style="width:100px;text-align: center;" id="'+(typeof(data[i].id) == 'undefined'?'':data[i].id)+'">' +
                '<input type="checkbox" value="'+data[i].id+'" onclick="addVar(this)"/>' +
                '</td>'+
                '<td style="word-break: break-all;width:250px">'+ (typeof(data[i].id) == 'undefined'?'':data[i].id) +'</td>'+
                '<td style="word-break: break-all;width:200px">'+ (typeof(data[i].address) == 'undefined'?'':data[i].address) +'</td>'+
                '<td style="word-break: break-all;width:200px">'+ (typeof(data[i].unit) == 'undefined'?'':data[i].unit) +'</td>';
            if(data.length<=3) {
                str += '<td style="word-break: break-all;width:119px">'+ writeable +'</td>';
            }else {
                str += '<td style="word-break: break-all;width:104px">'+ writeable +'</td>';
            }
            str +='</tr>';
        }
        if(str){
            $("#table2_tbody").empty().append(str);
        }else{
            $("#table2_tbody").empty().append('<td colspan="5" style="text-align: center;width:868px;height: 37px;background-color: #f9f9f9;" lang="text:no_data"></td>');
        }

        var $tr = $("#table2_tbody tr");
        if(vArr.length>0) {
            for(var j = 0; j < vArr.length; j++ ) {
                var varId = vArr[j].id;
                for(var i = 0; i < $tr.length; i++) {
                    var tr = $($tr[i]);
                    var tdId = tr.find("td:eq(0)").prop("id");
                    if(tdId==varId) {
                        tr.find("td:eq(0) input:eq(0)").prop("disabled", "disabled");
                        tr.find("td:eq(0) input:eq(0)").prop("checked", "checked");
                        break;
                    }
                }
            }
        }
        unload2();
        locale.render({element: "#init_body"});
    }

    //搜索趋势分组
    $("#searchGroup").click(function(){
        loading();
        var groupName = $.trim($("#group_inp").val());
            getTrends(site_Id,{"name":groupName},false,function(data){
                if(data.result) {
                    fillTableData(data.result);
                }else {
                    unload();
                    $("#table1_tbody").empty().append('<tr> <td colspan="5" style="text-align: center;" lang="text:no_data"></td></tr>');
                }
            },this);
        locale.render({element: "#init_body"});

    });

    //填充分组表格数据函数
    function fillTableData(data) {
        var str = "";
        if(data.length>0) {
            for(var i = 0; i < data.length; i++) {
                var type = typeof(data[i].type) == 'undefined'?'':data[i].type;
                if(type==1) {
                    type=locale.get("first");
                }else if(type==2) {
                    type=locale.get("historical_trend");
                }else if(type==3) {
                    type=locale.get("first")+"、"+locale.get("historical_trend");
                }else {
                    type = "";
                }
                var vars = "";
                if(typeof(data[i].vars)!="undefined"&&data[i].vars.length>0) {
                    for(var j = 0; j < data[i].vars.length; j++) {
                        var desc = typeof(data[i].vars[j].desc) == "undefined" ? "" : data[i].vars[j].desc;
                        if(j==data[i].vars.length-1) {
                            vars += desc;
                        }else {
                            vars +=desc+",";
                        }
                    }
                    if(vars.length>75){
                        vars = vars.substring(0,75) +"...";
                    }

                }
                str += '<tr>'+
                    '<td id="tableHead_selectAll" style="width:1%;">'+
                    '<input type="checkbox" data-toggle="tooltip" data-placement="bottom" lang="title:check_all" value="'+data[i].id+'"></td>'+
                    '<td style="word-break: break-all;width=20%;">'+ (typeof(data[i].name) == 'undefined'?'':data[i].name) +'</td>'+
                    '<td style="word-break: break-all;width=20%;">'+ type +'</td>'+
                    '<td style="width:50%;">'+vars+'</td>'+
                    "<td style='text-align:center;width=9%;'>" +
                    "<span data-toggle='tooltip' title='编辑' lang='title:edit' data-permissionFilter='[214]'" +
                    "onclick='showModel_edit_group(\"" + data[i].id + "\")' style='padding: 3px 6px;'><span class='glyphicon glyphicon-edit link-black' aria-hidden='true' style=' cursor: pointer;'></span>&nbsp;</span>" +
                    "<span data-toggle='tooltip' title='详情' lang='title:detail' data-permissionFilter='[213]'" +
                    "onclick='showModel_detail_group(\"" + data[i].id + "\")' style='padding: 3px 6px;'><span class='glyphicon glyphicon-th-list link-black' aria-hidden='true' style=' cursor: pointer;'></span>&nbsp;</span>" +
                    "</td>" +
                    '</tr>';
            }
            permissionFilter_pageFunc();
            locale.render({element: "#init_body"});
        }

        if(str=="") {
            $("#table1_tbody").empty().append('<tr> <td colspan="5" style="text-align: center;width:848px;" lang="text:no_data"></td></tr>');
        }else {
            $("#table1_tbody").empty().append(str);
            //给input添加onclick事件
            $("#table1_tbody > tr > td > input").on("click", function() {
                var selected_rolesId = $("#table1_tbody tr td input[type='checkbox']:checked");
                var allUsers_nowPage = $("#table1_tbody tr");
                if (selected_rolesId.length < allUsers_nowPage.length) {
                    $("#table1_checkbok").prop("checked", false);
                }
                if (selected_rolesId.length == allUsers_nowPage.length) {
                    $("#table1_checkbok").prop("checked", true);
                }
            });
        }
        unload();
        locale.render({element: "#init_body"});
    }

    //填充添加模态框变量表格数据函数
    function fillTableData2(data) {
        var str = "";
        for(var i =0; i < data.length; i++) {
            //把变量放入globalVars里
            globalVars.push(data[i]);
            var writeable;
            if(typeof(data[i].writeable)!="undefined") {
                writeable = locale.get("yesText");
            }else {
                writeable = locale.get("noText");
            }
            str += '<tr>'+
                    '<td style="width:100px;text-align: center;" id="'+(typeof(data[i].id) == 'undefined'?'':data[i].id)+'">' +
                    '<input type="checkbox" value="'+data[i].id+'" onclick="addVar(this)"/>' +
                    '</td>'+
                    '<td style="word-break: break-all;width:250px">'+ (typeof(data[i].id) == 'undefined'?'':data[i].id) +'</td>'+
                    '<td style="word-break: break-all;width:200px">'+ (typeof(data[i].address) == 'undefined'?'':data[i].address) +'</td>'+
                    '<td style="word-break: break-all;width:200px">'+ (typeof(data[i].unit) == 'undefined'?'':data[i].unit) +'</td>';
            if(data.length<=3) {
                str += '<td style="word-break: break-all;width:119px">'+ writeable +'</td>';
            }else {
                str += '<td style="word-break: break-all;width:104px">'+ writeable +'</td>';
            }
            str +='</tr>';
        }
        if(str) {
            $("#table2_tbody").empty().append(str);
        }else {
            $("#table2_tbody").empty().append('<td colspan="5" style="text-align: center;width:868px;height: 37px;background-color: #f9f9f9;" lang="text:no_data"></td>');
        }
        unload2();
        locale.render({element: "#init_body"});
    }

    //显示添加分组模态框
    $("#addGroup").click(function(){
        $('#addBox').modal({backdrop: 'static', keyboard: false, show: true});
        $(".formErrorContent").remove();
        $("#form_reset").click();
        vArr = []; //初始化变量数组
        $("#add_group_name").val("");
        $("#modal_title").prop("lang","text:add_group");
        $("#selectedVarContent").empty();
        getAllVars(0);
        locale.render({element: "#addBox"});
        locale.render({element: "#init_body"});
    });

    //提交趋势组
    $("#submitVariable").click(function(){
        if ($('#form_add_Group').validationEngine('validate')) {
            //数据采集
            var name = $("#add_group_name").val();
            var calc_mode = "instant";
            var checkedTypes = $("#type_div :checkbox:checked");
            if($(checkedTypes[0]).val()!="instant") {
                calc_mode = "!instant";
            }
            var type = "0";
            var checkedCalcModes = $("#display_div :checkbox:checked");
            if(checkedCalcModes.length==1) {
                if($(checkedCalcModes[0]).val()==1) {
                    type = "1";
                }else{
                    type = "2";
                }
            }else if(checkedCalcModes.length==2) {
                type = "3";
            }
            var siteId = site_Id;
            var reqeustData = {
                "siteId":siteId,
                "name":name,
                "type":type,
                "calc_mode":calc_mode,
                "vars":vArr
            };
            if($("#modal_title").text()==locale.get("add_group")) {
                if(site_Id=="") {
                    dialog.render({text:"现场下没有设备，请先添加设备"});
                }else {
                    addTrend(site_Id,{},true,reqeustData,function(data){
                        if(data.result) {
                            dialog.render({
                                lang:"submit_success",
                            });
                            $("#addBox").modal('hide');
                            getTrendList();
                        }else {
                            dialog.render({
                                lang:"submit_failed",
                            });
                        }
                    },this);
                }
            }else {
                reqeustData.id = groupId;
                editTrend(site_Id,groupId,{},true,reqeustData,function(data){
                    if(data.result) {
                        dialog.render({
                            lang:"submit_success",
                        });
                        $("#addBox").modal('hide');
                        getTrendList();
                    }else {
                        dialog.render({
                            lang:"submit_failed",
                        });
                    }
                },this);
            }


        }

        locale.render({element: "#init_body"});
    });

    // 显示编辑模态框
    function showModel_edit_group(group_Id) {
        $('#addBox').modal({backdrop: 'static', keyboard: false, show: true});
        $("#form_reset").click();
        $(".formErrorContent").remove();
        vArr = []; //初始化变量数组
        $("#add_group_name").val("");
        groupId = ""
        $("#modal_title").prop("lang","text:edit_group");
        $("#selectedVarContent").empty();
        $("#table2_tbody tr").each(function(){
            var $tr = $(this);
            $tr.find("td:eq(0) a:eq(0)").css("color","blue");

        });
        getTrendInfo(group_Id);
        locale.render({element: "#addBox"});
        locale.render({element: "#init_body"});
    }

    //获取特定趋势组信息
    function getTrendInfo(groupId) {
        if(groupId!="") {
            getTrend(site_Id,groupId,{},false,function(data){
                if(data.result) {
                    fillTrendInfo(data.result);
                }
            },this);
        }
    }

    //回填趋势分组信息
    function fillTrendInfo(data) {
        $("#add_group_name").val(data.name);
        groupId = data.id;
        var cacl_mode = data.calc_mode;
        if(cacl_mode=="instant") {
            $("#shunshi").click();
           // $("#type_div input:eq(0)").prop("checked","");
        }else {
            $("#tongji").click();
           // $("#type_div input:eq(1)").prop("checked","checked");
        }
        var type = data.type;
        if(type==1){
            $("#display_div input:eq(0)").prop("checked","checked");
        }else if(type==2){
            $("#display_div input:eq(1)").prop("checked","checked");
        }else if(type==3){
            $("#display_div input:eq(0)").prop("checked","checked");
            $("#display_div input:eq(1)").prop("checked","checked");
        }
        vArr = data.vars;
        var str = "";
        var $tr = $("#table2_tbody tr");
        if(vArr.length>0) {
            for(var i = 0; i < vArr.length; i++) {
                str += '<label><span >'+vArr[i].id+'</span><img  onclick="deleteVar(this)" style="cursor:pointer;margin-right:10px;" class="img-circle img-position" src="../images/delete.png"></label>'
            }
            $("#selectedVarContent").append(str);

            for(var j = 0; j < vArr.length; j++ ) {
                var varId = vArr[j].id;
                for(var i = 0; i < $tr.length; i++) {
                    var tr = $($tr[i]);
                    var tdId = tr.find("td:eq(0)").prop("id");
                    if(tdId==varId) {
                        tr.find("td:eq(0) input:eq(0)").prop("disabled", "disabled");
                        tr.find("td:eq(0) input:eq(0)").prop("checked", "checked");
                        break;
                    }
                }
            }
        }
    }

    //当页全选
    $("#table1_checkbok").on('click', function(event) {
        var selected = $("#table1_tbody tr td input[type='checkbox']:checked");
        var allSiteCurrentPage = $("#table1_tbody tr");
        if (allSiteCurrentPage.length > 0) {
            if (selected.length < allSiteCurrentPage.length) {
                $("#table1_tbody tr td input").prop("checked", true);
                $("#table1_checkbok").prop("checked", true);
            } else {
                $("#table1_tbody tr td input").prop("checked", false);
                $("#table1_checkbok").prop("checked", false);
            }
        }
    });

    //添加变量
    function addVar(element){
        var $input = $(element);
        var id = $input.val();
        var flag = false;
        for(var i = 0; i < vArr.length; i++){
            if(vArr[i].id==id) {
                flag = true;
                break;
            }
        }
        if(flag) {
            errorTipDis("variable_existing");
        }else {
            $input.prop("disabled","disabled");
            for(var i = 0; globalVars.length; i++) {
                if(globalVars[i].id==id) {
                    vArr.push(globalVars[i]);
                    break;
                }
            }
            $("#selectedVarContent").append('<label><span >'+id+'</span><img onclick="deleteVar(this)" style="cursor:pointer;margin-right:10px;" class="img-circle img-position" src="../images/delete.png"></label>');
        }
        locale.render({element: "#init_body"});
    }

    // 删除变量
    function deleteVar(element){
        dialog.render({
            lang: "delete_variable",
            buttons: [{lang: "yes", click: function() {
                var $img = $(element);
                var id = $img.parent().text();
                $img.parent().empty().remove();
                if(id!="") {
                    Array.prototype.remove=function(dx) {
                        if(isNaN(dx)||dx>this.length){return false;}
                        for(var i=0,n=0;i<this.length;i++) {
                            if(this[i]!=this[dx]) {
                                this[n++]=this[i]
                            }
                        }
                        this.length-=1
                    }
                    for(var i = 0; i < vArr.length; i++) {
                        if(vArr[i].id==id) {
                            vArr.remove(i);
                            break;
                        }
                    }
                }
                var $tr = $("#table2_tbody tr");
                for(var i = 0; i < $tr.length; i++) {
                    var tr = $($tr[i]);
                    var tdId = tr.find("td:eq(0)").prop("id");
                    if(tdId==id) {
                        tr.find("td:eq(0) input:eq(0)").prop("disabled", "");
                        tr.find("td:eq(0) input:eq(0)").prop("checked", "");
                        break;
                    }
                }
                dialog.close();
            }}, {lang: "no", click: function() {
                dialog.close();
            }}],
            close: function() {
                dialog.close();
            }
        });
        locale.render({element: "#init_body"});
    }

    //删除趋势组
    $("#deleteGroup").click(function() {
        var selected = $("#table1_tbody tr td input[type='checkbox']:checked");
        if (selected.length > 0) {
            dialog.render({
                lang: "delete_variable",
                buttons: [{lang: "yes", click: function() {
                    selected.each(function() {
                        deleteTrend(site_Id, $(this).val(),{},false);
                    });
                    $("#table1_checkbok").prop("checked","");
                    getTrendList();
                    dialog.close();
                }}, {lang: "no", click: function() {
                    dialog.close();
                }}],
                close: function() {
                    dialog.close();
                }
            });
        } else {
            errorTipDis("select_del");
        }
        locale.render({element: "#init_body"});
    });

    //显示趋势分组详情模态框
    function showModel_detail_group(group_id) {
        $('#detailBox').modal({backdrop: 'static', keyboard: false, show: true});
        vArr = []; //初始化变量数组
        $("#add_group_name").val("");
        getTrend(site_Id,group_id,{},true,function(data){
            var str = "";
            if(data.result) {
                $("#detail_group_name").val(data.result.name);
                if(data.result.vars.length>0){
                    for(var i = 0; i < data.result.vars.length; i++) {
                        if(typeof(data.result.vars[i].writeable)!="undefined") {
                            writeable = locale.get("yesText");
                        }else {
                            writeable = locale.get("noText");
                        }
                        str += '<tr>'+
                            '<td style="word-break: break-all;width:350px">'+ (typeof(data.result.vars[i].id) == 'undefined'?'':data.result.vars[i].id) +'</td>'+
                            '<td style="word-break: break-all;width:250px">'+ (typeof(data.result.vars[i].address) == 'undefined'?'':data.result.vars[i].address) +'</td>'+
                            '<td style="word-break: break-all;width:150px">'+ (typeof(data.result.vars[i].unit) == 'undefined'?'':data.result.vars[i].unit) +'</td>';
                        if(data.result.vars.length<=8) {
                            str += '<td style="word-break: break-all;width:119px">'+ writeable +'</td>';
                        }else {
                            str += '<td style="word-break: break-all;width:104px">'+ writeable +'</td>';
                        }
                         str += '</tr>';
                    }
                }
            }
            if(str) {
                $("#detail_tbody").empty().append(str);
            }else {
                $("#detail_tbody").empty().append('<tr><td colspan="4" style="text-align: center;width: 868px;" lang="text:no_data"></td></tr>');
            }
            locale.render({element: "#init_body"});
        },this);

    }

    //阻断keydown事件
    $('body').keypress(function(event) {
        if (event.keyCode === 10 || event.keyCode === 13)
            event.preventDefault();
    });
    // 添加enter按键事件
    $("#name_inp").keydown(function(e) {//当按下按键时
        if (event.keyCode === 10 || event.keyCode === 13) {//.which属性判断按下的是哪个键，回车键的键位序号为13
            $("#searchVariable").trigger("click");//触发搜索按钮的点击事件
        }
    });
    $("#group_inp").keydown(function(e) {//当按下按键时
        if (event.keyCode === 10 || event.keyCode === 13) {//.which属性判断按下的是哪个键，回车键的键位序号为13
            $("#searchGroup").trigger("click");//触发搜索按钮的点击事件
        }
    });
    function loading() {
        $("#load1").show();
    }
    function unload() {
        $("#load1").hide();
    }
    function loading2() {
        $("#load2").show();
    }
    function unload2() {
        $("#load2").hide();
    }
</script>
